const SUPABASE_URL=process.env.SUPABASE_URL||window.ENV?.SUPABASE_URL;const SUPABASE_ANON_KEY=process.env.SUPABASE_ANON_KEY||window.ENV?.SUPABASE_ANON_KEY;const{createClient}=window.supabase||{};let supabaseClient=null;function initSupabase(){if(!SUPABASE_URL||!SUPABASE_ANON_KEY){console.error('âŒ Supabase environment variables not configured');console.log('Add SUPABASE_URL and SUPABASE_ANON_KEY to Netlify environment variables');return null;}if(!supabaseClient){supabaseClient=createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{autoRefreshToken:true,persistSession:true,detectSessionInUrl:true}});}return supabaseClient;}async function signInWithMagicLink(email){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const{data,error}=await supabase.auth.signInWithOtp({email,options:{emailRedirectTo:`${window.location.origin}/dashboard.html`}});if(error){console.error('Sign in error:',error);return{error:error.message};}return{data,message:'Check your email for the magic link!'};}async function signOut(){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const{error}=await supabase.auth.signOut();if(error){console.error('Sign out error:',error);return{error:error.message};}localStorage.removeItem('tap-in-session');window.location.href='/';return{success:true};}async function getCurrentUser(){const supabase=initSupabase();if(!supabase)return null;const{data:{user}}=await supabase.auth.getUser();return user;}async function getSession(){const supabase=initSupabase();if(!supabase)return null;const{data:{session}}=await supabase.auth.getSession();return session;}function onAuthStateChange(callback){const supabase=initSupabase();if(!supabase)return()=>{};const{data:{subscription}}=supabase.auth.onAuthStateChange((event,session)=>{console.log('Auth state changed:',event,session?.user?.email);callback(event,session);});return()=>subscription.unsubscribe();}async function getUserProfile(userId){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const{data,error}=await supabase .from('user_profiles').select('*').eq('id',userId).single();if(error){console.error('Get profile error:',error);return{error:error.message};}return{data};}async function updateUserProfile(userId,updates){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const{data,error}=await supabase .from('user_profiles').update(updates).eq('id',userId).select().single();if(error){console.error('Update profile error:',error);return{error:error.message};}return{data};}async function createTeam(name,description=''){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const user=await getCurrentUser();if(!user)return{error:'Not authenticated'};const{data,error}=await supabase .from('teams').insert({name,description,created_by:user.id}).select().single();if(error){console.error('Create team error:',error);return{error:error.message};}return{data};}async function getMyTeams(){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const user=await getCurrentUser();if(!user)return{error:'Not authenticated'};const{data:memberships,error:memberError}=await supabase .from('team_members').select('team_id,role,joined_at').eq('user_id',user.id);if(memberError){console.error('Get memberships error:',memberError);return{error:memberError.message};}if(!memberships||memberships.length===0){return{data:[]};}const teamIds=memberships.map(m=>m.team_id);const{data:teams,error:teamsError}=await supabase .from('teams').select('*').in('id',teamIds);if(teamsError){console.error('Get teams error:',teamsError);return{error:teamsError.message};}const teamsWithRole=teams.map(team=>{const membership=memberships.find(m=>m.team_id===team.id);return{...team,role:membership?.role,joined_at:membership?.joined_at};});return{data:teamsWithRole};}async function joinTeam(inviteCode){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const user=await getCurrentUser();if(!user)return{error:'Not authenticated'};const{data:team,error:teamError}=await supabase .from('teams').select('*').eq('invite_code',inviteCode.trim().toLowerCase()).single();if(teamError||!team){console.error('Team not found:',teamError);return{error:'Invalid invite code'};}const{data:existing}=await supabase .from('team_members').select('*').eq('team_id',team.id).eq('user_id',user.id).single();if(existing){return{error:'Already a member of this team'};}const{data,error}=await supabase .from('team_members').insert({team_id:team.id,user_id:user.id,role:'member'}).select().single();if(error){console.error('Join team error:',error);return{error:error.message};}return{data:team};}async function getTeamMembers(teamId){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const{data,error}=await supabase .from('team_members').select(`*,user_profiles(id,email,name,company)`).eq('team_id',teamId);if(error){console.error('Get team members error:',error);return{error:error.message};}return{data};}async function leaveTeam(teamId){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const user=await getCurrentUser();if(!user)return{error:'Not authenticated'};const{error}=await supabase .from('team_members').delete().eq('team_id',teamId).eq('user_id',user.id);if(error){console.error('Leave team error:',error);return{error:error.message};}return{success:true};}async function saveAssessment(assessmentType,data,teamId=null,shareWithTeam=false){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const user=await getCurrentUser();if(!user)return{error:'Not authenticated'};const{data:assessment,error}=await supabase .from('assessments').insert({user_id:user.id,team_id:teamId,assessment_type:assessmentType,data:data,is_shared_with_team:shareWithTeam}).select().single();if(error){console.error('Save assessment error:',error);return{error:error.message};}return{data:assessment};}async function getMyAssessments(assessmentType=null){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const user=await getCurrentUser();if(!user)return{error:'Not authenticated'};let query=supabase .from('assessments').select('*').eq('user_id',user.id).order('created_at',{ascending:false});if(assessmentType){query=query.eq('assessment_type',assessmentType);}const{data,error}=await query;if(error){console.error('Get assessments error:',error);return{error:error.message};}return{data};}async function getTeamAssessments(teamId){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const{data,error}=await supabase .from('assessments').select(`*,user_profiles(id,email,name)`).eq('team_id',teamId).eq('is_shared_with_team',true).order('created_at',{ascending:false});if(error){console.error('Get team assessments error:',error);return{error:error.message};}return{data};}async function migrateLocalAssessment(localAssessment){const supabase=initSupabase();if(!supabase)return{error:'Supabase not configured'};const user=await getCurrentUser();if(!user)return{error:'Not authenticated'};const result=await saveAssessment(localAssessment.type||'leadership-style',localAssessment,null,false);return result;}async function isAuthenticated(){const session=await getSession();return!!session;}async function requireAuth(redirectUrl='/'){const authenticated=await isAuthenticated();if(!authenticated){localStorage.setItem('tap-in-redirect-after-login',window.location.href);window.location.href=redirectUrl;return false;}return true;}function handlePostLoginRedirect(){const redirectUrl=localStorage.getItem('tap-in-redirect-after-login');if(redirectUrl){localStorage.removeItem('tap-in-redirect-after-login');window.location.href=redirectUrl;}}window.TapInAuth={initSupabase,signInWithMagicLink,signOut,getCurrentUser,getSession,onAuthStateChange,isAuthenticated,requireAuth,handlePostLoginRedirect,getUserProfile,updateUserProfile,createTeam,getMyTeams,joinTeam,getTeamMembers,leaveTeam,saveAssessment,getMyAssessments,getTeamAssessments,migrateLocalAssessment};if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initSupabase);}else{initSupabase();}