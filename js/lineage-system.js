(function(){'use strict';function generateReferralCode(userName='User'){const existing=localStorage.getItem('userReferralCode');if(existing)return existing;const nameSlug=userName .toLowerCase().replace(/[^a-z0-9]/g,'').substring(0,10)||'user';const randomSuffix=Math.random().toString(36).substring(2,6).toUpperCase();const code=`${nameSlug}-${randomSuffix}`;localStorage.setItem('userReferralCode',code);return code;}function getUserReferralCode(){return localStorage.getItem('userReferralCode')||generateReferralCode();}function createReferralLink(referralCode=null){const code=referralCode||getUserReferralCode();const baseUrl=window.location.origin;const landingPage='index-DUAL-ENTRY.html';return `${baseUrl}/${landingPage}?ref=${code}`;}function getReferrerFromURL(){const urlParams=new URLSearchParams(window.location.search);return urlParams.get('ref');}function trackReferralOnStart(){const referrerCode=getReferrerFromURL();if(!referrerCode)return null;sessionStorage.setItem('referredBy',referrerCode);const myCode=getUserReferralCode();const lineage=getLineageChain(referrerCode);lineage.push(referrerCode);lineage.push(myCode);const userData={userId:generateUserId(),referralCode:myCode,referredBy:referrerCode,referralLineage:lineage,joinedDate:new Date().toISOString(),personalXP:0,currentBelt:'White'};saveUserData(userData);incrementStudentCount(referrerCode);return userData;}function getLineageChain(referrerCode){const referrerData=getUserDataByCode(referrerCode);if(!referrerData)return[];const chain=referrerData.referralLineage||[];return[...chain,referrerCode];}function saveUserData(userData){const users=getAllUsers();users[userData.userId]=userData;localStorage.setItem('lineageUsers',JSON.stringify(users));localStorage.setItem('currentUserId',userData.userId);}function getUserData(){const userId=localStorage.getItem('currentUserId');if(!userId){const code=getUserReferralCode();const userData={userId:generateUserId(),referralCode:code,referredBy:null,referralLineage:[],joinedDate:new Date().toISOString(),personalXP:parseInt(localStorage.getItem('totalXP')||'0'),currentBelt:getCurrentBelt()};saveUserData(userData);return userData;}const users=getAllUsers();return users[userId]||null;}function getUserDataByCode(referralCode){const users=getAllUsers();for(const userId in users){if(users[userId].referralCode===referralCode){return users[userId];}}return null;}function getAllUsers(){const stored=localStorage.getItem('lineageUsers');return stored ? JSON.parse(stored):{};}function generateUserId(){return 'user_'+Date.now()+'_'+Math.random().toString(36).substring(2,9);}function getCurrentBelt(){if(localStorage.getItem('blackBeltStripe4Complete'))return 'Black';if(localStorage.getItem('brownBeltStripe4Complete'))return 'Brown';if(localStorage.getItem('purpleBeltStripe4Complete'))return 'Purple';if(localStorage.getItem('blueBeltStripe4Complete'))return 'Blue';return 'White';}function incrementStudentCount(referrerCode){const referrer=getUserDataByCode(referrerCode);if(!referrer)return;referrer.studentsCount=(referrer.studentsCount||0)+1;saveUserData(referrer);updateLineageCounts(referrer.referralLineage);}function updateLineageCounts(lineage){lineage.forEach(code=>{const user=getUserDataByCode(code);if(user){user.lineageCount=(user.lineageCount||0)+1;saveUserData(user);}});}function getDirectStudents(userId=null){const currentUser=userId ? getUserDataByCode(userId):getUserData();if(!currentUser)return[];const users=getAllUsers();const students=[];for(const uid in users){if(users[uid].referredBy===currentUser.referralCode){students.push(users[uid]);}}return students.sort((a,b)=>new Date(b.joinedDate)-new Date(a.joinedDate));}function calculateTeamXP(userId=null){const students=getDirectStudents(userId);return students.reduce((total,student)=>{return total+(student.personalXP||0);},0);}function calculateLineageXP(userId=null){const currentUser=userId ? getUserDataByCode(userId):getUserData();if(!currentUser)return 0;let totalXP=0;const students=getDirectStudents(currentUser.userId);for(const student of students){totalXP+=(student.personalXP||0);totalXP+=calculateLineageXP(student.userId);}return totalXP;}function updateUserXP(xpAmount){const user=getUserData();if(!user)return;user.personalXP=(user.personalXP||0)+xpAmount;user.currentBelt=getCurrentBelt();saveUserData(user);if(user.referredBy){const referrer=getUserDataByCode(user.referredBy);if(referrer){referrer.teamXP=calculateTeamXP(referrer.userId);saveUserData(referrer);}}}function getGymStats(userId=null){const user=userId ? getUserDataByCode(userId):getUserData();if(!user)return null;const students=getDirectStudents(user.userId);const teamXP=calculateTeamXP(user.userId);const lineageXP=calculateLineageXP(user.userId);return{gymName:user.gymName||`${user.referralCode}'s Gym`,gymMotto:user.gymMotto||null,studentsCount:students.length,lineageCount:user.lineageCount||0,teamXP:teamXP,lineageXP:lineageXP,personalXP:user.personalXP||0,currentBelt:user.currentBelt||'White',joinedDate:user.joinedDate,students:students};}function getLeaderboard(type='teamXP',limit=100){const users=getAllUsers();const gyms=[];for(const userId in users){const user=users[userId];const stats=getGymStats(user.userId);if(stats&&stats.studentsCount>0){gyms.push({userId:user.userId,gymName:stats.gymName,referralCode:user.referralCode,studentsCount:stats.studentsCount,teamXP:stats.teamXP,lineageXP:stats.lineageXP,currentBelt:stats.currentBelt});}}if(type==='teamXP'){gyms.sort((a,b)=>b.teamXP-a.teamXP);}else if(type==='lineageXP'){gyms.sort((a,b)=>b.lineageXP-a.lineageXP);}else if(type==='students'){gyms.sort((a,b)=>b.studentsCount-a.studentsCount);}return gyms.slice(0,limit);}function getUserRank(type='teamXP'){const leaderboard=getLeaderboard(type,1000);const user=getUserData();if(!user)return null;const rank=leaderboard.findIndex(gym=>gym.userId===user.userId);return rank>=0 ? rank+1:null;}function setGymName(gymName){const user=getUserData();if(!user)return false;user.gymName=gymName;saveUserData(user);return true;}function setGymMotto(motto){const user=getUserData();if(!user)return false;user.gymMotto=motto;saveUserData(user);return true;}function syncXPFromLocalStorage(){const totalXP=parseInt(localStorage.getItem('totalXP')||'0');const user=getUserData();if(user&&user.personalXP!==totalXP){const xpDiff=totalXP-(user.personalXP||0);if(xpDiff>0){updateUserXP(xpDiff);}}}function initializeLineageSystem(){const referrerCode=getReferrerFromURL();if(referrerCode){trackReferralOnStart();}syncXPFromLocalStorage();const user=getUserData();if(user){user.currentBelt=getCurrentBelt();saveUserData(user);}}window.LineageSystem={generateReferralCode,getUserReferralCode,createReferralLink,getReferrerFromURL,trackReferralOnStart,getUserData,getUserDataByCode,getDirectStudents,calculateTeamXP,calculateLineageXP,updateUserXP,getGymStats,getLeaderboard,getUserRank,setGymName,setGymMotto,syncXPFromLocalStorage,initializeLineageSystem};if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initializeLineageSystem);}else{initializeLineageSystem();}})();